# Conduct a code review and describe the problems

#### 1. Хранение данных от мануфактурщика в CSV

1. Скорее всего понадобиться удалять какие-то записи, какие-то трюфели будут проданы или истечет срок годности, <br>с csv это становится большой проблемой.
2. При необходимости очень сложно обрабатывать эти данные, делать какие-то выборки, фильтрацию, сортировку, статистику или сделать надбавку к цене.
3. При работе с данными, нужно будет все время обращаться к двум источникам к CSV и БД - лишнее неудобство.
4. Хранить эти данные в БД безопасней, так как там есть встроенный механизм бэкапа, доступ к данным по аутентификации и ролям.

#### 2. Использование одного сервера приложения для получения по FTP файла<br>от мануфактурщика и хостинга для ресторанов итогового файла
1. Ненадежно - если упадет сервер, рестораны не смогут скачивать файл, мануфактурщики загружать.
2. Не совсем представляю как часто рестораны будут скачивать файл, но в целом, хранение итогового файла на отдельном FTP позволит снизить нагрузку на основной сервер.
3. Думаю, что небезопасно открывать сторонним людям доступ к основному серверу даже к ограниченной его части.
4. Неудобно будет делать несколько инстансов сервера, при необходимости в будущем лучше справляться с нагрузкой (написано, что есть миллионы охотников)

#### 3. Постоянное добавление новых записей в файл, который в это же время будут постоянно скачивать
1. Скорее всего это может приводить к повреждению файла или к поврежденным данным, которые получат рестораны.
2. Возможны проблемы с файлом, если произойдет ошибка в коде во время записи в файл.

#### 4. Нет логирования и обработки ошибок

#### 5. Разные проблемы в коде: повторяющийся код, регистрация трюфелей и авторизация в одном контроллере, <br>метка времени expired_at и created_at ставится одинаковая, не валидируются данные авторизации, не испольуются возможности Laravel для работы с файлами и т.д

#### 6. Когда тестировал через Postman, error ответы API приходили в WEB формате

# Describe the improvements if they are required

#### 1. Убрать хранение данных мануфактурщика в CSV / Сделал
Передалал джобу импортирующую данные. Сделал запись в БД по одной строке, но лучше переделать, чтобы записывал чанками. Оставил запись UUID в REDIS, чтобы при загрузке файлов с милионом записей быстрее делать проверку и не загружать БД.

#### 2. Добавить FTP хостинги для файла ресторана и для получения файла от мануфактурщика. / Сделал
Переделал работу с файлами через фасад Storage, чтобы удобней обращаться к FTP, работать с высокоуровневой логикой, проще понимать код. Хотя я не уверен, какие права доступа он выставляет при создании файлов и остальном, в реальном проекте нужно было бы проверить. Также нужно было бы выставить корректные права доступа на FTP хостингах, например, только на чтение ресторанов.

#### 3. Сделать отдельную джобу, записывающие новые данные в файл для ресторанов / Сделал
Тут, возможно, спорный вопрос, так как не понятно насколько критично для бизнеса, если трюфель от охотника появится в итоговом файле не в ту же секунду. Но мне показалось, что обновление раз в 5 минут или при необходимости раз в минуту будет достаточно.<br>При загрузке обновлений в файл, сначало создается временный файл в закрытой от пользователей директории, потом файл обновляется, переносится в основную директорию, старый файл удаляется, а новому меняется название.<br>
Такой сценарий мне показался наиболее надежным. Но я точно не знаю, как будет работать FTP, при попытке удалить файл, который кто-то загружает, в реальном проекте это надо было бы протестировать и возможно как-то поменять логику.<br>Также отделить выгрузку данных для рестораннов в отдельный процесс соотносится с принципом единой ответственности.
#### 4. Добавить логирование и обработку ошибок / Сделал
Также надо настроить, логирование неотловленных ошибок, вроде по дефолту этого нет, и логирование стектрейса.

#### 5. Разное / Сделал
1. Вынес валидацию запросов в Form Request классы. Использовал встроенные валидаторы Laravel.
2. Добавил нейминг роутов.
3. Разделил контроллер для авторизации и для загрузки трюфелей.
4. Привел роут загрузку трюфелей к конвенциональному в Laravel виду - apiResource, store.
5. В таблицу трюфелей добавил user_id - кто загрузил трюфель.
6. Сделал возврат необработанных ошибок в формате JSON.
7. Сделал Trait для ответов API, чтобы они имели единообразную структуру.
8. Добавил валидацию при получении токена.
9. Прописал типы возвращаемых данных в методах.
10. Поменял способ проверки токена - через встроенный мидлвар Sanctum.
11. created_at и expires_at записывались одинаковые, поправил.
12. Используемые в разных местах параметры вынес в config. 
13. Добавил в роут версию API.
14. При обработке данных мануфактурщика добавил проверку размера и формата файла и времени обновление, чтобы не обрабатывать уже обработанный файл.
15. Продуктовый вопрос, но так как нет интерфейса для охотников, кажется логичным добавить возврат sku при регистрации трюфеля.

#### 6. Разное / Не сделал
1. Доработать авторизацию, чтобы было время жизни токена и рефреш токен.
2. Доработать роут регистрации трюфелей, чтобы можно было загружать данные массивом (уменьшит количество запросов к серверу).
3. Разделить все джобы на отдельные очереди.
4. Возможно можно убрать ключ уникальности у sku в БД, так как есть проверка через Redis, а ключ при записи будет просматривать всю БД.
5. Настроить нотификации, например, если джоба выдала ошибку определенное количество раз. 
6. Логи слать в какой-то сборщик логов, чтобы было удобнее анализировать. 
7. Сделать Rate Limiting для API. 
8. Уточнить параметры timeout и tries для каждой джобы (сейчас поставил всем одинаковые). Вынести эти параметры в переменные окружения.
9. Какие-то параметры, как директории, названия файлов, частотность запуска джоб, можно вынести в переменные окружения, чтобы можно было их менять без пересборки проекта. 
10. Разделить роуты на группы и файлы.
11. Добавить API для регистрации, логаута, обновления токена.
12. Вынести логику регистрации трюфелей в отдельный сервис.

# Run the project using any convenient tool, like Laravel Sail
Использовал.

# Implement these improvements and make a pull request
Помимо вышенаписанного, в некоторых местах кода добавил TODO с описанием доработок.

# Ensure the quality of the tests
Все тесты поправил с учетом изменений в коде. Разделил на отдельные файлы и сгрупировал на API и Jobs.<br> 
Надо добавить готовые CSV файлы для тестирования, чтобы не генерировать каждый раз. Добавить больше проверок возвращаемых значений. Проверок, что записываются в БД или в CSV именно те значения, которые должны.<br>
Наверно, Было бы полезно добавить тест, проверяющий работу с большим CSV файлом на миллион записей.
Также в файле с тестами в TODO написал какие ещё тест кейсы надо добавить.
